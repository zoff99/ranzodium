name: Maven Package CI

on:
  push:
  pull_request:
  release:
    types: [published, edited]
  workflow_dispatch:
    inputs:
      version:
        description: dummy
        default: dummy

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: install basic android SDK
      run: |
           sudo apt update && \
           sudo DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends \
           android-sdk \
           lsb-release \
           clang \
           cmake \
           libconfig-dev \
           libgtest-dev \
           ninja-build \
           pkg-config \
           zip grep file ca-certificates autotools-dev autoconf automake \
           git bc wget rsync cmake make pkg-config libtool \
           ssh gzip tar \
           coreutils \
           curl \
           libncurses5 \
           wget \
           git \
           curl \
           software-properties-common \
           unzip \
           zip \
           automake \
           autotools-dev \
           build-essential \
           check \
           checkinstall \
           libtool \
           libfreetype6-dev \
           fontconfig-config \
           libfontconfig1-dev \
           pkg-config \
           openjdk-8-jdk

    - name: Install NDK
      run: |
           echo ${ANDROID_SDK_ROOT}
           # find / -name sdkmanager 2>/dev/null
           ls -al /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager
           echo "y" | sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --install "ndk;21.0.6113669" --sdk_root=${ANDROID_SDK_ROOT}
           echo "y" | sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --install "ndk;20.1.5948944" --sdk_root=${ANDROID_SDK_ROOT}
           # sdkmanager --update
           # sdkmanager 'cmdline-tools;latest'
           # sdkmanager --uninstall 'cmdline-tools;1.0'

    - name: pkgs
      run: |
           sudo apt update && \
           sudo DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends \
           clang \
           cmake \
           libconfig-dev \
           libgtest-dev \
           ninja-build \
           pkg-config \
           zip grep file ca-certificates autotools-dev autoconf automake \
           git bc wget rsync cmake make pkg-config libtool \
           ssh gzip tar \
           coreutils \
           yasm \
           libncurses5

    - name: use mnt dir
      run: |
           sudo mkdir -p /root/work/
           sudo mv -v /root/work /mnt/
           sudo ls -al /mnt
           sudo bash -c "cd /root/ ; ln -s /mnt/work; ls -al"

    - name: move_source
      run: |
           sudo mkdir -p /root/work/
           sudo cp -av /home/runner/work/ranzodium/ranzodium/* /root/work/
           sudo cp -av /home/runner/work/ranzodium/ranzodium/.??* /root/work/

    - name: set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
        distribution: 'temurin'

    - name: check java versions installed
      run: |
           echo $JAVA_HOME||echo "NO ERR"
           type -a java

    - name: build_maven_deps
      run: |
           java -version
           sudo mkdir -p ~/work/deploy
           sudo mkdir -p ~/.android/
           sudo touch ~/.android/debug.keystore
           sudo mkdir -p build_dir
           sudo mkdir -p /home/runner/work/ranzodium/ranzodium/build_dir
           pwd
           ls -al
           sudo bash -c "cd /home/runner/work/ranzodium/ranzodium/build_dir/;../build_scripts/deps.sh"

    - name: build_maven_pkg
      run: |
           pwd
           sudo bash -c "cd /home/runner/work/ranzodium/ranzodium/build_dir/;../build_scripts/buildlib.sh '../'"

    - name: acls_maven_pkg
      run: |
           sudo chmod -R a+rx /root/work/artefacts/
           sudo ls -al /root/work/artefacts/
           sudo bash -c 'cp -av /root/work/artefacts/*.zip /home/runner/work/'

    - name: upload apk
      uses: actions/upload-artifact@v4
      with:
        name: local_maven_ranzodium_jni.zip
        path: /home/runner/work/*.zip

